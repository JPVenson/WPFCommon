<Window x:Class="WpfApplication1.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:wpfApplication1="clr-namespace:WpfApplication1"
        xmlns:system="clr-namespace:System;assembly=mscorlib"
        xmlns:validationTyps="clr-namespace:JPB.ErrorValidation.ValidationTyps;assembly=JPB.ErrorValidation"
        xmlns:objectModel="clr-namespace:System.Collections.ObjectModel;assembly=System"
        xmlns:validationRules="clr-namespace:JPB.ErrorValidation.ValidationRules;assembly=JPB.ErrorValidation"
        xmlns:collections="clr-namespace:System.Collections;assembly=mscorlib"
        mc:Ignorable="d"
        
        Title="MainWindow" Height="350" Width="525"
        d:DataContext="{d:DesignInstance wpfApplication1:TestWindowViewModel}">

	<Window.Resources>
        <ResourceDictionary x:Key="Dictionary">
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary
                Source="/PresentationFramework.Aero;component/themes/Aero.NormalColor.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
        <SolidColorBrush Color="#FFCB2E2E" x:Key="ErrorForgroundColor"/>
		<SolidColorBrush Color="#11FF0000" x:Key="ErrorBackgroundColor"/>

		<DataTemplate x:Key="Validation" DataType="{x:Type validationTyps:IValidation}">
            <TextBlock Foreground="{StaticResource ErrorForgroundColor}" Text="{Binding ErrorText}" />
        </DataTemplate>

        <DataTemplate DataType="{x:Type ValidationError}">
            <ContentControl Content="{Binding ErrorContent}" ContentTemplate="{StaticResource Validation}"/>
        </DataTemplate>

        <DataTemplate x:Key="ErrorPopupContent" DataType="{x:Type collections:IList}">
            <GroupBox Header="{Binding Count}">
                <ListBox ItemsSource="{Binding}" />
            </GroupBox>
        </DataTemplate>
		
		<ControlTemplate x:Key="MultiErrorControl">
			<Grid>
				<Border BorderBrush="{StaticResource ErrorForgroundColor}" BorderThickness="1" Background="{StaticResource ErrorBackgroundColor}"
                                    IsHitTestVisible="False" x:Name="errorBorder" />
				<AdornedElementPlaceholder x:Name="placeholder" />
				<Popup AllowsTransparency="True" HorizontalAlignment="Right" HorizontalOffset="0"
                                   VerticalOffset="0" PopupAnimation="Fade" Placement="Right"
                                   PlacementTarget="{Binding ElementName=errorBorder}"
                                   IsOpen="{Binding ElementName=placeholder, Path=AdornedElement.IsFocused, Mode=OneWay}">
					<StackPanel Orientation="Horizontal">
						<Polygon VerticalAlignment="Top" Points="0,4 4,0 4,8" Fill="{StaticResource ErrorForgroundColor}"
                                             Stretch="Fill" Margin="0 5 0 0" Stroke="{StaticResource ErrorForgroundColor}"
                                             StrokeThickness="2" />
						<Border Background="{StaticResource ErrorForgroundColor}" CornerRadius="4" Padding="4">
							<ContentControl ContentTemplate="{StaticResource ErrorPopupContent}" Content="{Binding }"/>
						</Border>
					</StackPanel>
				</Popup>
			</Grid>
		</ControlTemplate>
		<Style TargetType="{x:Type TextBox}">
			<Setter Property="Validation.ErrorTemplate" Value="{StaticResource MultiErrorControl}" />
		</Style>
		<Style TargetType="{x:Type ComboBox}">
			<Setter Property="Validation.ErrorTemplate" Value="{StaticResource MultiErrorControl}" />
		</Style>
	</Window.Resources>

    <DockPanel>
        <Button DockPanel.Dock="Top" Command="{Binding TaskACommand}">TaskA</Button>
        <Button DockPanel.Dock="Top" Command="{Binding TaskBCommand}">TaskB</Button>
        <Label DockPanel.Dock="Top" Content="{Binding IsValidating}" />
		<DockPanel DockPanel.Dock="Top">
			<TextBlock DockPanel.Dock="Right"
                       IsEnabled="False"
                       Text="{Binding IsValidating}"/>
			<TextBox DockPanel.Dock="Left"
                         IsEnabled="False"
                 Text="{Binding ToValidationString, Mode=TwoWay,
                 ValidatesOnDataErrors=True,
                 NotifyOnValidationError=True,
                 UpdateSourceTrigger=PropertyChanged}"
                 Height="25" />
		</DockPanel>
		
		
		<ItemsControl DockPanel.Dock="Top" ItemsSource="{Binding ActiveValidationCases}">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <TextBlock Text="{Binding ErrorText}" Foreground="Red" />
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!--<TextBox
            Style="{StaticResource {x:Type TextBox}}"
            DockPanel.Dock="Top"
                 Text="{Binding ToValidationString, ValidatesOnNotifyDataErrors=True, UpdateSourceTrigger=PropertyChanged}" />

        <TextBox DockPanel.Dock="Top" Text="{Binding ToValidationString, UpdateSourceTrigger=PropertyChanged}"/>
        <Label Content="{Binding Error}"></Label>-->
    </DockPanel>
</Window>